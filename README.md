# tg-bridge

It is a bridge for telegram internal API https://core.telegram.org/ (there is no way to get messages from telegram via bot api)

Communal organizations publish their events on telegram channels, messengers are source of truth for these events.

Communal outages messages could be parsed from these channels for the first time:

* @vodokanalpmrcom
* @eresofficial

The service gets messages from configured channels with configured interval and saves in external db as state last message id from parsed channel.

There could be configured more than one channel because of restrictions of telegram api.

After parsing, it saves original message with metadata to db and push it to queue for further processing.


# How to generate Telegram session

ℹ️ _Skip this step if session is already generated/provided._

⚠️ Be cautious and don't generate session too often to not get your service Telegram blocked.

Application is using cached Telegram session which is provided from environment variables.
Session is base64 encoded JSON which is generated during session generation.
In order to generate the session first time (or regenerate) build and run the `tg-session` application:
```go
go build -o bin/tg-session ./cmd/tg-session
bin/tg-session generate --apiHash "YOUR_API_HASH" --apiId YOUR_API_ID --phone "+YOUR_PHONE"
```

Find generated session base64 encoded printed into console.
Generated session is trimmed version of full JSON originally generated by Telegram API.
This is to avoid very long encoded session string hard to work with.
Trimmed session will contain only following fields that still allows initiating Telegram session 
successfully.
```json
{
  "Version": 1,
  "Data": {
    "DC": DATA_CENTER_NUMBER_HERE,
    "Addr": "",
    "AuthKey": "AUTH_KEY_HERE",
    "AuthKeyID": "AUTH_KEY_ID_HERE",
    "Salt": SALT_HERE
  }
}
```


# How to run the application
Add required environment variables:
- `TELEGRAM_API_ID`=YOUR_API_ID_HERE
- `TELEGRAM_API_HASH`="YOUR_API_HASH_HERE"
- `TELEGRAM_SESSION`="YOUR_SESSION_JSON_ENCODED_INTO_BASE64_FORMAT"
- `TEMPORAL_HOST_PORT` - Host:Port of temporal server
- `TEMPORAL_NAMESPACE` - Namespace for temporal tasks
- `TEMPORAL_TASK_QUEUE` - Task queue name
- `TEMPORAL_WORKFLOW_TYPE` - Workflow type name

There is also an optional environment variable:
- `HTTP_PORT`=1234 - default port for http server, if not provided 8080 will be used.

In order to run main `tg-bridge` application build and run the application:
```go
go build -o bin/tg-bridge ./cmd/tg-bridge 
TELEGRAM_API_ID=YOUR_API_ID TELEGRAM_API_HASH="YOUR_API_HASH" TELEGRAM_SESSION="GENERATED_TELEGRAM_SESSION" bin/tg-bridge
```

# How to build tg-bridge image

You could simply call `./scripts/buildpack-build-image.sh` script to build image.

It requires `pack` [cli tool](https://buildpacks.io/docs/for-platform-operators/how-to/integrate-ci/pack/) to be installed.

There are also environment variables that could be used to customize image build:

`IMAGE` - image name to build
`BUILDER` - builder to use for building image
`BUILDPACK` - buildpack to use for building image
`PUBLISH` - if set to `true` image will be published to registry